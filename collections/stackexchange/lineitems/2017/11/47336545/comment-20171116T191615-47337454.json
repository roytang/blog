{"id": 47337454, "name": "ehennum", "url": "https://stackoverflow.com/users/1091497/ehennum", "text": "If I'm understanding correctly, you should be able to implement that with a single Optic query that groups twice. \r\n\r\n - The first group should aggregate to the company level\r\n - The second group should aggregate to the member level, collecting the detail with the array aggregate\r\n\r\nThe query would probably look something like the following: \r\n\r\n    const results =\r\n      op.fromView('test', 'claims')\r\n        .groupBy(['member_id', 'company'], [\r\n            'member_name',\r\n            op.count('company_claims', 'claim_no'),\r\n            op.sum('company_amount', 'claim_amount')\r\n            ])\r\n        .select(['member_id',\r\n            'member_name',\r\n            'company_claims',\r\n            'company_amount',\r\n            op.as('company_desc', op.jsonObject([\r\n                    op.prop('company',    op.col('company')),\r\n                    op.prop('num_claims', op.col('company_claims'))\r\n                    ]))\r\n            ])\r\n        .groupBy(['member_id'], [\r\n            'member_name',\r\n            op.sum('num_claims',   'company_claims'),\r\n            op.sum('total_amount', 'company_amount'),\r\n            op.arrayAggregate('companies', 'company_desc')\r\n            ])\r\n        .orderBy(op.desc('total_amount'))\r\n        .limit(200)\r\n        .result()\r\n        .toArray();\r\n\r\nBy the way, if you specify a column in the aggregates list, it is sampled.  Where the column has the same value for the entire group (which I presume is the case with \"member_name\"), you can sample it instead of specifying it as an additional grouping key.\r\n\r\nAlso, in modern JavaScript var is usually avoided in favor of const or let.\r\n\r\nHoping that helps,", "date": "2017-11-16 19:16:15", "photo": "https://www.gravatar.com/avatar/293bdd8ee3ce350e5de5e2e7a705db59?s=128&d=identicon&r=PG", "source_url": "https://stackoverflow.com/questions/47336545/marklogic-optic-api", "mention_url": "https://stackoverflow.com/questions/47336545/marklogic-optic-api", "source": "stackexchange"}